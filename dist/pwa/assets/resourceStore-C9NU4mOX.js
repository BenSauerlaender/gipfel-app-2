import{aV as D,aU as N,aW as T}from"./index-DaOUFlu6.js";const C=(t,e)=>e.some(r=>t instanceof r);let E,k;function J(){return E||(E=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function W(){return k||(k=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const S=new WeakMap,x=new WeakMap,v=new WeakMap;function V(t){const e=new Promise((r,n)=>{const a=()=>{t.removeEventListener("success",o),t.removeEventListener("error",i)},o=()=>{r(y(t.result)),a()},i=()=>{n(t.error),a()};t.addEventListener("success",o),t.addEventListener("error",i)});return v.set(e,t),e}function H(t){if(S.has(t))return;const e=new Promise((r,n)=>{const a=()=>{t.removeEventListener("complete",o),t.removeEventListener("error",i),t.removeEventListener("abort",i)},o=()=>{r(),a()},i=()=>{n(t.error||new DOMException("AbortError","AbortError")),a()};t.addEventListener("complete",o),t.addEventListener("error",i),t.addEventListener("abort",i)});S.set(t,e)}let F={get(t,e,r){if(t instanceof IDBTransaction){if(e==="done")return S.get(t);if(e==="store")return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return y(t[e])},set(t,e,r){return t[e]=r,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function O(t){F=t(F)}function z(t){return W().includes(t)?function(...e){return t.apply(B(this),e),y(this.request)}:function(...e){return y(t.apply(B(this),e))}}function q(t){return typeof t=="function"?z(t):(t instanceof IDBTransaction&&H(t),C(t,J())?new Proxy(t,F):t)}function y(t){if(t instanceof IDBRequest)return V(t);if(x.has(t))return x.get(t);const e=q(t);return e!==t&&(x.set(t,e),v.set(e,t)),e}const B=t=>v.get(t);function G(t,e,{blocked:r,upgrade:n,blocking:a,terminated:o}={}){const i=indexedDB.open(t,e),l=y(i);return n&&i.addEventListener("upgradeneeded",u=>{n(y(i.result),u.oldVersion,u.newVersion,y(i.transaction),u)}),r&&i.addEventListener("blocked",u=>r(u.oldVersion,u.newVersion,u)),l.then(u=>{o&&u.addEventListener("close",()=>o()),a&&u.addEventListener("versionchange",s=>a(s.oldVersion,s.newVersion,s))}).catch(()=>{}),l}const K=["get","getKey","getAll","getAllKeys","count"],X=["put","add","delete","clear"],P=new Map;function U(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(P.get(e))return P.get(e);const r=e.replace(/FromIndex$/,""),n=e!==r,a=X.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!(a||K.includes(r)))return;const o=async function(i,...l){const u=this.transaction(i,a?"readwrite":"readonly");let s=u.store;return n&&(s=s.index(l.shift())),(await Promise.all([s[r](...l),a&&u.done]))[0]};return P.set(e,o),o}O(t=>({...t,get:(e,r,n)=>U(e,r)||t.get(e,r,n),has:(e,r)=>!!U(e,r)||t.has(e,r)}));const Q=["continue","continuePrimaryKey","advance"],L={},M=new WeakMap,j=new WeakMap,Y={get(t,e){if(!Q.includes(e))return t[e];let r=L[e];return r||(r=L[e]=function(...n){M.set(this,j.get(this)[e](...n))}),r}};async function*Z(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const r=new Proxy(e,Y);for(j.set(r,e),v.set(r,B(e));e;)yield r,e=await(M.get(r)||e.continue()),M.delete(r)}function $(t,e){return e===Symbol.asyncIterator&&C(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&C(t,[IDBIndex,IDBObjectStore])}O(t=>({...t,get(e,r,n){return $(e,r)?Z:t.get(e,r,n)},has(e,r){return $(e,r)||t.has(e,r)}}));class R{constructor(e,r,n){this.remoteLastModified=null,this.localLastModified=null,this.state="empty",this.error=null,this.entryCount=0,this.id=e,this.db=r,this.apiUrl=n}clearPrivateFields(){this.remoteLastModified=null,this.localLastModified=null,this.state="empty",this.error=null,this.entryCount=0}async checkForUpdates(){try{const e=await D.get(`/api/last-modified/${this.apiUrl}`);return(!e||!e.data)&&(this.remoteLastModified=null),this.remoteLastModified=new Date(e.data),this.isOutdated()}catch{console.log(`Failed to check for updates for resource ${this.id}`),this.remoteLastModified=null}}isOutdated(){return this.remoteLastModified?this.localLastModified?this.remoteLastModified>this.localLastModified:!0:!1}async clear(){return this.state="processing",this.db.clear(this.id).then(()=>{this.clearPrivateFields(),console.log(`Cleared resource ${this.id} from IndexedDB`)}).catch(e=>{throw this.state="empty",this.error=e,e})}async update(){throw new Error("Method must be implemented by subclass")}async load(){throw new Error("Method must be implemented by subclass")}}class ee extends R{constructor(){super(...arguments),this.data=null}getEntryCount(){return this.data===null?0:Array.isArray(this.data)?this.data.length:Object.keys(this.data).length}async update(){try{this.state="processing",console.log(`Loading ${this.id} data from API...`);const e=await D.get(`/resources/${this.apiUrl}`);if(!e||!e.data||!e.data.data||e.status!==200)throw new Error(`No data received for ${this.id}`);let r=e.data.data;const n=new Date(e.data.date);Array.isArray(r)&&r.length===1&&(r=r[0]),this.data=r,this.entryCount=this.getEntryCount(),console.log(`Saving ${this.id} data to IndexedDB...`),await this.db.put(this.id,{id:"data",value:{data:r,date:n}}),this.localLastModified=n,this.data=r,this.state="loaded",this.error=null,console.log(`${this.id} data loaded successfully`)}catch(e){console.error(`Error updating ${this.id} data`,e),this.error=e,this.state="empty",this.entryCount=0,this.localLastModified=null,this.data=null}}async load(){try{console.log(`Loading ${this.id} data from IndexedDB...`);const e=await this.db.get(this.id,"data");this.data=e?.value?.data??null,this.localLastModified=e?.value?.date??null,this.getEntryCount()>0&&(this.state="loaded",this.entryCount=this.getEntryCount()),console.log(`${this.id} data loaded successfully from IndexedDB`)}catch(e){console.error(`Error loading ${this.id} data from IndexedDB`,e)}}async clear(){return await super.clear().then(()=>{this.data=null})}}function te(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function oe(t){if(Object.prototype.hasOwnProperty.call(t,"__esModule"))return t;var e=t.default;if(typeof e=="function"){var r=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};r.prototype=e.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(t).forEach(function(n){var a=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(r,n,a.get?a:{enumerable:!0,get:function(){return t[n]}})}),r}var b={exports:{}},re=b.exports,_;function ne(){return _||(_=1,function(t,e){(function(r,n){t.exports=n()})(re,function(){function r(s){function h(c){for(var f=0,w=p.length;f<w;++f)p[f](c);m.push(c)}if(typeof Promise!="function")throw new Error("Promise implementation not available in this environment.");var p=[],m=[],d=new Promise(function(c,f){s(c,f,h)});d.progress=function(c){if(typeof c!="function")throw new Error("cb is not a function.");for(var f=0,w=m.length;f<w;++f)c(m[f]);return p.push(c),d};var g=d.then;return d.then=function(c,f,w){return g.call(d,c,f),w!==void 0&&d.progress(w),d},d}function n(s){if(!(s instanceof ArrayBuffer))throw new TypeError("arrayBuffer is not an instance of ArrayBuffer.");if(!i.Worker)throw new Error("Worker implementation is not available in this environment.");return new r(function(h,p,m){var d=new Worker(o),g=[];d.onerror=function(c){p(c)},d.onmessage=function(c){switch(c=c.data,c.type){case"log":console[c.data.level]("Worker: "+c.data.msg);break;case"extract":var f=a(c.data);g.push(f),m(f);break;case"complete":d.terminate(),h(g);break;case"error":d.terminate(),p(new Error(c.data.message));break;default:d.terminate(),p(new Error("Unknown message from worker: "+c.type))}},d.postMessage({type:"extract",buffer:s},[s])})}function a(s){return Object.defineProperties(s,u),s}var o,i=window||this,l=i.URL||i.webkitURL,u={blob:{get:function(){return this._blob||(this._blob=new Blob([this.buffer]))}},getBlobUrl:{value:function(){return this._blobUrl||(this._blobUrl=l.createObjectURL(this.blob))}},readAsString:{value:function(){for(var s=this.buffer,h=s.byteLength,p=1,m=new DataView(s),d=[],g=0;g<h;++g){var c=m.getUint8(g*p,!0);d.push(c)}return this._string=String.fromCharCode.apply(null,d)}},readAsJSON:{value:function(){return JSON.parse(this.readAsString())}}};return o=(window||this).URL.createObjectURL(new Blob(['"use strict";function UntarWorker(){}function decodeUTF8(e){for(var r="",t=0;t<e.length;){var a=e[t++];if(a>127){if(a>191&&a<224){if(t>=e.length)throw"UTF-8 decode: incomplete 2-byte sequence";a=(31&a)<<6|63&e[t]}else if(a>223&&a<240){if(t+1>=e.length)throw"UTF-8 decode: incomplete 3-byte sequence";a=(15&a)<<12|(63&e[t])<<6|63&e[++t]}else{if(!(a>239&&a<248))throw"UTF-8 decode: unknown multibyte start 0x"+a.toString(16)+" at index "+(t-1);if(t+2>=e.length)throw"UTF-8 decode: incomplete 4-byte sequence";a=(7&a)<<18|(63&e[t])<<12|(63&e[++t])<<6|63&e[++t]}++t}if(a<=65535)r+=String.fromCharCode(a);else{if(!(a<=1114111))throw"UTF-8 decode: code point 0x"+a.toString(16)+" exceeds UTF-16 reach";a-=65536,r+=String.fromCharCode(a>>10|55296),r+=String.fromCharCode(1023&a|56320)}}return r}function PaxHeader(e){this._fields=e}function TarFile(){}function UntarStream(e){this._bufferView=new DataView(e),this._position=0}function UntarFileStream(e){this._stream=new UntarStream(e),this._globalPaxHeader=null}if(UntarWorker.prototype={onmessage:function(e){try{if("extract"!==e.data.type)throw new Error("Unknown message type: "+e.data.type);this.untarBuffer(e.data.buffer)}catch(r){this.postError(r)}},postError:function(e){this.postMessage({type:"error",data:{message:e.message}})},postLog:function(e,r){this.postMessage({type:"log",data:{level:e,msg:r}})},untarBuffer:function(e){try{for(var r=new UntarFileStream(e);r.hasNext();){var t=r.next();this.postMessage({type:"extract",data:t},[t.buffer])}this.postMessage({type:"complete"})}catch(a){this.postError(a)}},postMessage:function(e,r){self.postMessage(e,r)}},"undefined"!=typeof self){var worker=new UntarWorker;self.onmessage=function(e){worker.onmessage(e)}}PaxHeader.parse=function(e){for(var r=new Uint8Array(e),t=[];r.length>0;){var a=parseInt(decodeUTF8(r.subarray(0,r.indexOf(32)))),n=decodeUTF8(r.subarray(0,a)),i=n.match(/^\\d+ ([^=]+)=(.*)\\n$/);if(null===i)throw new Error("Invalid PAX header data format.");var s=i[1],o=i[2];0===o.length?o=null:null!==o.match(/^\\d+$/)&&(o=parseInt(o));var f={name:s,value:o};t.push(f),r=r.subarray(a)}return new PaxHeader(t)},PaxHeader.prototype={applyHeader:function(e){this._fields.forEach(function(r){var t=r.name,a=r.value;"path"===t?(t="name",void 0!==e.prefix&&delete e.prefix):"linkpath"===t&&(t="linkname"),null===a?delete e[t]:e[t]=a})}},UntarStream.prototype={readString:function(e){for(var r=1,t=e*r,a=[],n=0;n<e;++n){var i=this._bufferView.getUint8(this.position()+n*r,!0);if(0===i)break;a.push(i)}return this.seek(t),String.fromCharCode.apply(null,a)},readBuffer:function(e){var r;if("function"==typeof ArrayBuffer.prototype.slice)r=this._bufferView.buffer.slice(this.position(),this.position()+e);else{r=new ArrayBuffer(e);var t=new Uint8Array(r),a=new Uint8Array(this._bufferView.buffer,this.position(),e);t.set(a)}return this.seek(e),r},seek:function(e){this._position+=e},peekUint32:function(){return this._bufferView.getUint32(this.position(),!0)},position:function(e){return void 0===e?this._position:void(this._position=e)},size:function(){return this._bufferView.byteLength}},UntarFileStream.prototype={hasNext:function(){return this._stream.position()+4<this._stream.size()&&0!==this._stream.peekUint32()},next:function(){return this._readNextFile()},_readNextFile:function(){var e=this._stream,r=new TarFile,t=!1,a=null,n=e.position(),i=n+512;switch(r.name=e.readString(100),r.mode=e.readString(8),r.uid=parseInt(e.readString(8)),r.gid=parseInt(e.readString(8)),r.size=parseInt(e.readString(12),8),r.mtime=parseInt(e.readString(12),8),r.checksum=parseInt(e.readString(8)),r.type=e.readString(1),r.linkname=e.readString(100),r.ustarFormat=e.readString(6),r.ustarFormat.indexOf("ustar")>-1&&(r.version=e.readString(2),r.uname=e.readString(32),r.gname=e.readString(32),r.devmajor=parseInt(e.readString(8)),r.devminor=parseInt(e.readString(8)),r.namePrefix=e.readString(155),r.namePrefix.length>0&&(r.name=r.namePrefix+"/"+r.name)),e.position(i),r.type){case"0":case"":r.buffer=e.readBuffer(r.size);break;case"1":break;case"2":break;case"3":break;case"4":break;case"5":break;case"6":break;case"7":break;case"g":t=!0,this._globalPaxHeader=PaxHeader.parse(e.readBuffer(r.size));break;case"x":t=!0,a=PaxHeader.parse(e.readBuffer(r.size))}void 0===r.buffer&&(r.buffer=new ArrayBuffer(0));var s=i+r.size;return r.size%512!==0&&(s+=512-r.size%512),e.position(s),t&&(r=this._readNextFile()),null!==this._globalPaxHeader&&this._globalPaxHeader.applyHeader(r),null!==a&&a.applyHeader(r),r}};'])),n})}(b)),b.exports}var se=ne();const A=te(se);class ae extends R{constructor(){super(...arguments),this.fontFileCount=0,this.tileFileCount=0,this.styleJson=null,this.spriteJson=null,this.spritePNG=null}clearPrivateFields(){this.fontFileCount=0,this.tileFileCount=0,this.styleJson=null,this.spriteJson=null,this.spritePNG=null,super.clearPrivateFields()}async apiRequest(e,r={}){const n=await D.get(`/resources/${this.apiUrl}/${e}`,r);if(!n||!n.data||n.status!==200)throw new Error(`No data received for ${this.id} endpoint: ${e}`);return n.data}async update(){try{this.state="processing",console.log(`Loading ${this.id} data from API...`);const[e,r,n,a,o]=await Promise.all([this.apiRequest("fonts",{responseType:"arraybuffer",headers:{Accept:"application/gzip"}}).then(s=>A(s)),this.apiRequest("sprite/png",{responseType:"blob",headers:{Accept:"image/png"}}),this.apiRequest("sprite/json"),this.apiRequest("style"),this.apiRequest("tiles",{responseType:"arraybuffer",headers:{Accept:"application/gzip"}}).then(s=>A(s))]);console.log(`Download finished. Saving ${this.id} data to IndexedDB...`);const i=this.db.transaction(this.id,"readwrite"),l=i.objectStore(this.id);this.fontFileCount=0,this.tileFileCount=0;const u=new Date;for(const s of e)if(s.name.startsWith("fonts/")&&s.name.endsWith(".pbf")){const h=s.name.replace("fonts/","").replace(".pbf","");await l.put({id:h,value:s.buffer}),this.fontFileCount++}console.log(`Stored ${this.fontFileCount} fonts`),await l.put({id:"fontCount",value:this.fontFileCount});for(const s of o)if(s.name.startsWith("tiles/")&&s.name.endsWith(".pbf")){const h=s.name.replace(".pbf","");await l.put({id:h,value:s.buffer}),this.tileFileCount++}console.log(`Stored ${this.tileFileCount} tiles`),await l.put({id:"tileCount",value:this.tileFileCount}),await l.put({id:"spritePNG",value:r}),await l.put({id:"spriteJson",value:n}),await l.put({id:"styleJson",value:a}),await l.put({id:"date",value:u}),await i.done,await this.load(),console.log(`${this.id} data loaded successfully`)}catch(e){console.error(`Error updating ${this.id} data`,e),this.clearPrivateFields(),this.error=e}}async load(){try{console.log(`Loading ${this.id} data from IndexedDB...`);const e=this.db.transaction(this.id,"readonly"),r=e.objectStore(this.id),n=await r.get("date"),a=await r.get("fontCount"),o=await r.get("spritePNG"),i=await r.get("spriteJson"),l=await r.get("styleJson"),u=await r.get("tileCount");await e.done;const s=n?.value,h=a?.value,p=o?.value,m=i?.value,d=l?.value,g=u?.value;!s||!h||!p||!m||!d||!g||g===0||h===0?(console.log(`No data found for ${this.id} in IndexedDB`),this.clearPrivateFields()):(this.styleJson=d,this.spriteJson=m,this.spritePNG=await createImageBitmap(p),this.fontFileCount=h,this.tileFileCount=g,this.entryCount=5,this.localLastModified=new Date(s),this.state="loaded",this.error=null,console.log(`${this.id} data loaded successfully from IndexedDB`))}catch(e){this.clearPrivateFields(),this.error=e,console.error(`Error loading ${this.id} data from IndexedDB`,e)}}async clear(){return await super.clear().then(()=>{this.clearPrivateFields(),console.log(`Cleared resource ${this.id} from IndexedDB`)})}async getMapFontsGlyph(e,r){const n=`${e}/${r}`;try{const a=this.db.transaction(this.id,"readonly"),i=await a.objectStore(this.id).get(n);if(await a.done,!i||!i.value)throw new Error(`No glyphs found for font ${e} and range ${r}`);return i.value}catch(a){throw console.error(`Error fetching glyph ${n} from IndexedDB`,a),a}}async getMapTile(e,r,n){const a=`tiles/${e}/${r}/${n}`;try{const o=this.db.transaction(this.id,"readonly"),l=await o.objectStore(this.id).get(a);return await o.done,!l||!l.value?void 0:{data:l.value}}catch(o){throw console.error(`Error fetching tile ${a} from IndexedDB`,o),o}}}const I=["ascents","trips","summits","climbers","routes","regions"],ce=N("resource",{state:()=>({db:null,resources:[]}),getters:{getResourceById:t=>e=>t.resources.find(r=>r.id===e),isAllLoaded:t=>Array.from(t.resources).every(e=>e.state==="loaded"),isMinimumLoaded:t=>t.resources.filter(e=>I.includes(e.id)).every(e=>e.state==="loaded")},actions:{async checkForUpdates(){return(await T()).status!==200?(console.log("Cannot check for updates, no internet connection"),!1):(await Promise.all(this.resources.map(r=>r.checkForUpdates()))).some(r=>r===!0)},async updateAll(){await Promise.all(this.resources.map(t=>{if(t.isOutdated())return t.update()}))},async clearAll(){await Promise.all(this.resources.map(t=>t.clear()))},async loadAll(){await Promise.all(this.resources.map(t=>t.load()))},async init(){this.db=await G("gipfel-app",5,{upgrade(t){I.forEach(e=>{t.objectStoreNames.contains(e)||t.createObjectStore(e,{keyPath:"id"})}),t.objectStoreNames.contains("offline-map")||t.createObjectStore("offline-map",{keyPath:"id"})}}),I.forEach(t=>{const e=new ee(t,this.db,`${t}`);this.resources.push(e)}),this.resources.push(new ae("offline-map",this.db,"map"))}}});export{te as a,oe as g,ce as u};
